<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<!-- Load d3 -->
<script src="//d3js.org/d3.v5.js"></script>


<h1>Crime in the United States13</h1>


<body onload="main()">
<div id="buttons">
    <button id="one">
        1
    </button>
    <button id="two">
        2
    </button>
    <button id="three">
        3
    </button>
</div>
<div id="scene1">    
</div>
<div id="scene2">
</div>
<div id="scene3">
    <select id="states">
        
    </select>
</div>
<script>

var margin = {top: 20, right: 180, bottom: 30, left: 60},
    width = 850 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;
    
var svg2 = d3.select("#scene2");
   /* .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);
    svg2.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    console.log(svg2);*/
var legendLabels = [ "60+", "50-59", "40-49", "30-39", "25-29", "21-24", "18-20", "Under 18"];
    
var svg3 = d3.select("#scene3");
    /*.append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");*/

var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

//var button1 = document.getElementById('one');
//var button2 = document.getElementById('two');
//var button3 = document.getElementById('three');
    

    
//Read the data
async function main() {
    const ageData = await d3.csv("data/age.csv",
    (d) => {
       return {
           crime: d.crime,
           total: parseFloat(d.total.replace(/,/g, '')),
           under_18: (parseFloat(d.under_18.replace(/,/g, ''))/parseFloat(d.total.replace(/,/g, '')))*100,
           _18to20: (parseFloat(d._18to20.replace(/,/g, ''))/parseFloat(d.total.replace(/,/g, '')))*100,
           _21to24: (parseFloat(d._21to24.replace(/,/g, ''))/parseFloat(d.total.replace(/,/g, '')))*100,
           _25to29: (parseFloat(d._25to29.replace(/,/g, ''))/parseFloat(d.total.replace(/,/g, '')))*100,
           _30to39: (parseFloat(d._30to39.replace(/,/g, ''))/parseFloat(d.total.replace(/,/g, '')))*100,
           _40to49: (parseFloat(d._40to49.replace(/,/g, ''))/parseFloat(d.total.replace(/,/g, '')))*100,
           _50to59: (parseFloat(d._50to59.replace(/,/g, ''))/parseFloat(d.total.replace(/,/g, '')))*100,
           _60_plus: (parseFloat(d._60_plus.replace(/,/g, ''))/parseFloat(d.total.replace(/,/g, '')))*100,
       };
    });
    
    const murderData = await d3.csv("data/murder_guns.csv",
    (d) => {
       return {
           state: d.state,
           total_murders: parseFloat(d.total_murders.replace(/,/g, '')),
           total_firearms: parseFloat(d.total_firearms.replace(/,/g, '')),
           handguns: parseFloat(d.handguns.replace(/,/g, '')),
           rifles: parseFloat(d.rifles.replace(/,/g, '')),
           shotguns: parseFloat(d.shotguns.replace(/,/g, '')),
           unknown_firearm: parseFloat(d.unknown_firearm.replace(/,/g, '')),
           knives: parseFloat(d.knives.replace(/,/g, '')),
           other_weapon: parseFloat(d.other_weapon.replace(/,/g, '')),
           hands: parseFloat(d.hands.replace(/,/g, ''))
       };
    });
    
    function updateSelection(isOne, isTwo, isThree) {
        if (isOne) {

        } else if (isTwo) {
            d3.select('#scene3').selectAll('svg').remove();
            svg2 = d3.select("#scene2")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);
            svg2.append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            update2(ageData);
        } else if (isThree) {
            d3.select('#scene2').selectAll('svg').remove();
            svg3 = d3.select("#scene3")
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            var currentState = "Alabama";
            update3(murderData.filter(function(d) { return d.state == currentState;}));
            update3(murderData.filter(function(d) { return d.state == currentState;}));
        }
    }
    
    document.getElementById('one').onclick = function() {updateSelection(true, false, false);};
    document.getElementById('two').onclick = function() {updateSelection(false, true, false);};
    document.getElementById('three').onclick = function() {updateSelection(false, false, true);};

    var sel = document.getElementById('states');
    var fragment = document.createDocumentFragment();
    murderData.forEach(function(d) {
        var opt = document.createElement('option');
        opt.value = d.state;
        opt.innerHTML = d.state;
        fragment.appendChild(opt);
    });
    sel.appendChild(fragment);
    d3.select('#states')
        .on('change', function() {
       currentState = d3.select(this).property('value');
        update3(murderData.filter(function(d) { return d.state == currentState;}))
    });
    
    function update3(data) {

         var x = d3.scaleBand()
            .domain(["Handguns", "Rifles", "Shotguns", "Unknown Firearm", "Knives", "Other Weapon", "Hands"])
            .range([ 0, width])
            .paddingInner(.05);
        svg3.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));
    
        var y = d3.scaleLinear()
            .domain([0,1000])
            .range([ height, 0]);
        svg3.append("g")
            .call(d3.axisLeft(y));
        
        var handguns = svg3.selectAll(".handguns")
          .data(data);
        
        handguns.enter().append("rect")
          .style("fill", "steelblue")
          .attr("class", "handguns")
          .attr("x", x("Handguns"))
          .attr("width", x.bandwidth());
        
        handguns.transition()
            .duration(500)
          .attr("y", function(d) { return y(d.handguns); })
          .attr("height", function(d) { return height - y(d.handguns); });
        
        handguns.exit().remove();
        
        var rifles = svg3.selectAll(".rifles")
          .data(data);
        
        rifles.enter().append("rect")
          .style("fill", "steelblue")
          .attr("class", "rifles")
          .attr("x", x("Rifles"))
          .attr("width", x.bandwidth());
        
        rifles.transition()
          .duration(500)
          .attr("y", function(d) { return y(d.rifles); })
          .attr("height", function(d) { return height - y(d.rifles); });
        
        rifles.exit().remove();
        
        var shotguns = svg3.selectAll(".shotguns")
          .data(data);
        
        shotguns.enter().append("rect")
          .style("fill", "steelblue")
          .attr("class", "shotguns")
          .attr("x", x("Shotguns"))
          .attr("width", x.bandwidth());
        
        shotguns.transition()
          .duration(500)
          .attr("y", function(d) { return y(d.shotguns); })
          .attr("height", function(d) { return height - y(d.shotguns); });
        
        shotguns.exit().remove();
        
        var unknown_firearm = svg3.selectAll(".unknown_firearm")
          .data(data);
        
        unknown_firearm.enter().append("rect")
          .style("fill", "steelblue")
          .attr("class", "unknown_firearm")
          .attr("x", x("Unknown Firearm"))
          .attr("width", x.bandwidth());
        
        unknown_firearm.transition()
          .duration(500)
          .attr("y", function(d) { return y(d.unknown_firearm); })
          .attr("height", function(d) { return height - y(d.unknown_firearm); });
        
        unknown_firearm.exit().remove();
        
        var knives = svg3.selectAll(".knives")
          .data(data);
        
          knives.enter().append("rect")
          .style("fill", "steelblue")
          .attr("class", "knives")
          .attr("x", x("Knives"))
          .attr("width", x.bandwidth());
        
        knives.transition()
          .duration(500)
          .attr("y", function(d) { return y(d.knives); })
          .attr("height", function(d) { return height - y(d.knives); });
        
        knives.exit().remove();
        
        var other_weapon = svg3.selectAll(".other_weapon")
          .data(data);

          other_weapon.enter().append("rect")
          .style("fill", "steelblue")
          .attr("class", "other_weapon")
          .attr("x", x("Other Weapon"))
          .attr("width", x.bandwidth());
        
        other_weapon.transition()
          .duration(500)
          .attr("y", function(d) { return y(d.other_weapon); })
          .attr("height", function(d) { return height - y(d.other_weapon); });
        
        other_weapon.exit().remove();
        
        var hands = svg3.selectAll(".hands")
          .data(data);
        
          hands.enter().append("rect")
          .style("fill", "steelblue")
          .attr("class", "hands")
          .attr("x", x("Hands"))
          .attr("width", x.bandwidth());
        
        hands.transition()
          .duration(500)
          .attr("y", function(d) { return y(d.hands); })
          .attr("height", function(d) { return height - y(d.hands); });
        
        hands.exit().remove();
    }
    

    function update2(ageData) {
        
        var x = d3.scaleBand()
            .domain(ageData.map(function(d) {return d.crime;}))
            .range([ 0, width])
            .paddingInner(.05);
        svg2.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));
    
        var y = d3.scaleLinear()
            .domain([0,100])
            .range([ height, 0]);
        svg2.append("g")
            .call(d3.axisLeft(y));

        var z = d3.scaleOrdinal(d3.schemeCategory10).domain(ageData.columns.slice(2));
        var stack = d3.stack();
        
        svg2.selectAll(".serie")
            .data(stack.keys(ageData.columns.slice(2))(ageData))
            .enter().append("g")
                .attr("class", "serie")
                .attr("fill", function(d) {return z(d.key); })
            .selectAll("rect")
            .data(function(d) { return d; })
            .enter().append("rect")
                .attr("x", function(d) { return x(d.data.crime); })
                .attr("y", function(d) { return y(d[1]); })
                .attr("height", function(d) { return y(d[0]) - y(d[1]); })
                .attr("width", x.bandwidth())
                .on("mouseover", function(d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    var percent = (d[1] - d[0]).toFixed(2);
                    var count = Math.round(d.data.total * ((d[1] - d[0])/100));
                    tooltip.html(count +" people (" + percent + "%)")
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY) + "px");          
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
    
        var legend = svg2.selectAll(".legend")
            .data(ageData.columns.slice(2).reverse())
            .enter().append("g")
                .attr("class", "legend")
                .attr("transform", function(d, i) {return "translate(0," + i*20 + ")";})
                .style("font", "10px sans-serif");
    
        legend.append("rect")
            .attr("x", width + 18)
            .attr("width", 18)
            .attr("height", 18)
            .attr("fill", z);
    
        legend.append("text")
            .attr("x", width + 44)
            .attr("y", 9)
            .attr("dy", ".35em")
            .attr("text-anchor", "start")
            .text(function(d, i) { return legendLabels[i]; });
    }
        
    
    
}

    



</script>
    </body>